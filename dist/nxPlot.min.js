/*! Thu Feb 08 2024 18:41:00 GMT+0000 (Greenwich Mean Time) */
!function(){"use strict";const e="[nxPlot]",t=t=>console.log(`${e} ${t}`),a=t=>console.error(`${e} Error: ${t}`),s=()=>document.documentElement.classList.contains("theme-dark"),r={dark:{blue:"#63d7d6",highlight:"#fff",green:"#65d235",red:"#ea2b34",greenSeries:["#65d235","#A5D712","#02B546"],redSeries:["#ea2b34","#F64A2D","#C92845"],yellowSeries:["#FAD94B","#E8B131","#F1F555"],standard:["#1451b3","#175ece","#1a69e5"],varied:["#0a83ea","#18949f","#781cea","#3f0aea"],dual:["#1472DE","#2E4259"]},light:{blue:"#00f",highlight:"#000",green:"#418c20",red:"#da3e43",greenSeries:["#418c20","#598617","#139149"],redSeries:["#da3e43","#E64C02","#E64562"],yellowSeries:["#FCCE14","#E69812","#FCBB21"],standard:["hsl(217,20%,65%)","hsl(217,28%,62%)","hsl(217,20%,59%)"],varied:["#0a2aea","#ea0a8e","#00b827","#890aea"],dual:["#2126C2","#8FAEC2"]}},o=()=>s()?r.dark.blue:r.light.blue,i=e=>{const t=s()?"dark":"light";switch(e){case"varied":return r[t].varied;case"posNeg":return r[t].dual;case"rightEyeSeries":return r[t].greenSeries;case"leftEyeSeries":return r[t].redSeries;case"BEOSeries":return r[t].yellowSeries;default:return r[t].standard}},l=function(e){let t={linecolor:s()?"#666":"#999",linewidth:1,showgrid:!0,gridcolor:s()?"#292929":"#e6e6e6",tickmode:"auto",nticks:10,ticks:"outside",ticklen:3,tickcolor:s()?"#666":"#ccc",automargin:!0,mirror:!0,connectgaps:!1};const a="y"===e.type;if(e.hasOwnProperty("noMirrorLines")&&(t.mirror=!1),e.hasOwnProperty("domain")&&a&&(t.domain=e.domain),e.hasOwnProperty("title")&&(t.title={text:e.title,standoff:a?10:20,font:{size:12}}),e.hasOwnProperty("rightSide")&&a&&(t.overlaying=e.rightSide,t.side="right",t.showgrid=!1,t.zeroline=!1,t.title.standoff=15),e.hasOwnProperty("maxAxisTicks")&&(t.nticks=e.maxAxisTicks),e.hasOwnProperty("useDates")&&(t.tickformat="%b %Y"),e.hasOwnProperty("fixRange")&&(t.fixedrange=!0),e.hasOwnProperty("range")&&(t.range=e.range),e.hasOwnProperty("axisType")&&(t.type=e.axisType),e.hasOwnProperty("useCategories")){let a=e.useCategories.categoryarray;if(t.type="category",t.categoryarray=a,e.useCategories.rangeFit)switch(e.useCategories.rangeFit){case"exact":t.range=[0,a.length-1];break;case"pad":t.range=[-1,a.length];break;case"padTop":t.range=[0,a.length];break;case"padBottom":t.range=[-1,a.length-1]}}if(e.hasOwnProperty("spikes")){const e=s();t.showspikes=!0,t.spikecolor=e?"#0ff":"#00f",t.spikethickness=e?.5:1,t.spikedash=e?"1px,3px":"2px,3px"}return t},n=function(e){const t=s(),a={isDark:t,autosize:!0,margin:{l:50,r:50,t:30,b:40,pad:4,autoexpand:!0},paper_bgcolor:t?"rgba(100,100,100,0.1)":"rgba(255,255,255,0.4)",plot_bgcolor:t?"#111":"#fff",font:{family:"Roboto, 'Open Sans', verdana, arial, sans-serif",size:11,color:t?"#aaa":"#333"},hoverlabel:{bgcolor:t?"#003":"#fff",bordercolor:t?"#009":"#00f",font:{size:11,color:o()}},shapes:[],annotations:[]};if(e.hasOwnProperty("hovermode")?a.hovermode=e.hovermode:a.hovermode="closest",e.hasOwnProperty("colors")?a.colorway=i(e.colors):a.colorway=i("default"),e.hasOwnProperty("plotTitle")&&(a.title={text:e.plotTitle,xref:"paper",yref:"container",x:0,y:1,yanchor:"top",pad:{t:20},font:{size:15}},a.margin.t=50),e.hasOwnProperty("legend")){a.showlegend=!0;const t={font:{size:9},itemclick:"toggleothers",orientation:"h",xanchor:"right",yanchor:"bottom",x:1,y:1};"boolean"==typeof e.legend?a.legend=t:a.legend=Object.assign(t,e.legend)}else a.showlegend=!1;if(e.hasOwnProperty("subplot")&&(a.grid={rows:e.subplot,columns:1,pattern:"independent"}),e.hasOwnProperty("xaxis")&&(a.xaxis=e.xaxis,a.xaxis.title&&(a.margin.b=80)),e.hasOwnProperty("yaxes")&&e.yaxes.forEach(((e,t)=>{t?a["yaxis"+(t+1)]=e:a.yaxis=e,e.title&&("right"==e.side?a.margin.r=80:a.margin.l=80)})),e.hasOwnProperty("rangeSlider")){const s={thickness:.08};t&&(s.bgcolor=a.paper_bgcolor,s.borderwidth=1,s.bordercolor=a.plot_bgcolor),"boolean"!=typeof e.rangeSlider&&(s.range=e.rangeSlider),a.xaxis.rangeslider=s,a.margin.b=15}return e.hasOwnProperty("dateRangeButtons")&&(a.xaxis.rangeselector=Object.assign({x:1,xanchor:"right",buttons:[{label:"Show all",step:"all"},{label:"2 Yr",step:"year",count:2},{label:"1 Yr",step:"year",count:1},{label:"6 Mth",step:"month",count:6}]},(e=>({font:{color:e?"#ccc":"#666"},bgcolor:e?"rgb(30,46,66)":"rgb(255,255,255)",activecolor:e?"rgb(7,69,152)":"rgb(225,225,225)",bordercolor:e?"rgb(10,26,36)":"rgb(255,255,255)",borderwidth:2}))(t))),e.hasOwnProperty("barmode")&&(a.barmode=e.barmode),a},d=(e,t,a,s)=>{e.shapes=e.shapes.concat(t.map(a)),e.annotations=e.annotations.concat(t.map(s))},y={showarrow:!1,align:"left",font:{color:o()},borderpad:2},h=(e,t,a)=>{d(e,t,(({x:e})=>({type:"line",layer:"above",yref:"paper",x0:e,y0:0,x1:e,y1:a,line:{color:o(),width:.5}})),(({name:e,x:t})=>({...y,text:e,textangle:90,x:t,xshift:8,yref:"paper",y:a})))},c={div:null,data:[],layout:{},lines:{v:{verticals:[],h:0},horizontals:[]},storeKeys:{layout:"layout",plot:"plot"},stored:new Map,setSelectableUnits(){a("needs overwriting in specific layout")},buildData(){},buildLayout(){},addVerticalLines(e,t){return Array.isArray(e)||a("core"),this.lines.v.verticals=e,this.lines.v.h=t,this},addHorizontalLines(e){return Array.isArray(e)||a("core"),this.lines.horizontals=e,this},plotlyReact(){this.drawLines(this.layout),Plotly.react(this.div,this.data,this.layout,{displayModeBar:!1,responsive:!0})},drawLines(e){this.lines.v.verticals.length&&h(e,this.lines.v.verticals,this.lines.v.h),this.lines.horizontals.length&&((e,t)=>{d(e,t,(({y:e,yaxis:t})=>({type:"line",layer:"below",xref:"paper",yref:t,x0:0,y0:e,x1:1,y1:e,line:{color:o(),width:2,dash:"3px,12px"}})),(({name:e,y:t,yaxis:a})=>({...y,text:e,xref:"paper",x:0,yshift:8,yref:a,y:t})))})(e,this.lines.horizontals)},prebuild(){},setPlotlyDiv(e){if(!1===e)return t("assuming split view DOM"),!1;this.div=document.getElementById(e),null===this.div&&a(`div is null: ${e}`)},storeLayoutDataForRebuild(e){this.stored.has(this.storeKeys.layout)||this.stored.set(this.storeKeys.layout,e)},storePlotDataForThemeRebuild(e){this.stored.has(this.storeKeys.plot)||this.stored.set(this.storeKeys.plot,e)},rebuild(){this.stored.has(this.storeKeys.plot)&&this.buildData(this.stored.get(this.storeKeys.plot)),this.stored.has(this.storeKeys.layout)&&this.buildLayout(this.stored.get(this.storeKeys.layout)),this.plotlyReact()},plotlyThemeChange(){this.rebuild()}},u={buildLayout(e){this.storeLayoutDataForRebuild(e);const t=l({type:"x",numTicks:20,title:e.xaxis.title}),a=l({type:"y",numTicks:20,title:e.yaxis.y1.title});return this.layout=n({plotTitle:e.plotHeader,xaxis:t,yaxes:[a],barmode:"stack"}),this},buildData(e){const t={y:e.y,name:e.name,type:"bar"};return e.hasOwnProperty("x")&&(t.x=e.x),e.hasOwnProperty("hovertemplate")&&(t.hovertemplate=e.hovertemplate),this.data=[t],this}},p={...c,...u},g=({error_y:e})=>({type:"data",array:e,visible:!0,thickness:.5}),m=(e,{x:t,y:a},s)=>({yaxis:e,x:t,y:a,name:s,type:"scatter"}),b=(e=!1,t=!1)=>{let a=t?{dash:"2px,2px",width:2}:{};return e&&(a.color=e),a},x=(e,t,a,s,r)=>({...m(t,e,`${s}: ${a} `),hovertemplate:`Mean ± SD<br>${a}: %{y}<br>(N: %{x})`,line:b(r,!0),error_y:g(e)}),v={buildLayout(e){this.storeLayoutDataForRebuild(e);const t=l({type:"x",numTicks:10,spikes:!0,noMirrorLines:!0}),a=l({type:"y",title:e.yaxis.y1.title,range:e.yaxis.y1.range,spikes:!0}),s=l({type:"y",title:e.yaxis.y2.title,range:e.yaxis.y2.range,rightSide:"y1",spikes:!0});return this.layout=n({legend:!0,xaxis:t,yaxes:[a,s],rangeSlider:!0}),this},buildData(e){this.storePlotDataForThemeRebuild(e);let t=[];const a={rightEye:"R",leftEye:"L",BEO:"BEO"};for(const s of Object.keys(a))if(e.hasOwnProperty(s)){const r=i(`${s}Series`),o=a[s];t=t.concat([x(e[s].CRT,"y1","CRT",o,r[1]),x(e[s].VA,"y2","VA",o,r[0])])}return this.data=t,this}},f={...c,...v},w=e=>"number"==typeof e[0]?(e=>({range:e,axisType:"linear"}))(e):(e=>({useCategories:{showAll:!0,categoryarray:e}}))(e),k=(e,t=!1)=>{const a=document.createElement("div");return a.className=e,t&&(a.innerHTML=t),a},S=(e,t=!1,a=!1)=>{const s=document.createElement(e);return t&&(s.className=t),a&&(s.innerHTML=a),s},L={layout:null,div:null,userSelected:{hoverMode:"closest",vaUnits:""},selectableUnits:!1,linkToLayout(e){return this.layout=e,this.buildDOM(),this},buildDOM(){const e=document.querySelector(".oeplot");null===e&&a("toolBar is only for Summary pages, it requires the div.oeplot structure"),this.div=k("oeplot-toolbar"),e.append(this.div),e.classList.add("with-toolbar")},userChangesSomething(e,t){switch(e){case"plotPointsHoverMode":this.userSelected.hoverMode=t;break;case"vaUnits":this.userSelected.vaUnits=t;break;default:return}this.layout.rebuild()},allowUserToChangeHoverMode(){this.buildDropDown("plotPointsHoverMode","Show labels as:",[{text:"Single",value:this.hoverMode},{text:"Closest",value:"x"},{text:"Grouped",value:"x unified"}])},getHoverMode(){return this.userSelected.hoverMode},allowUserToSelectUnits:function(e){this.userSelected.vaUnits=Object.keys(e).at(0),this.selectableUnits=e;const t=Object.entries(e).map((([e,t])=>({value:e,text:t.name})));this.buildDropDown("vaUnits","Select VA Units",t)},getSelectedUnit(){return this.userSelected.vaUnits},getSelectedUnitNameRange(){return this.selectableUnits[this.getSelectedUnit()]},buildDropDown(e,t,a){const s=S("select");for(const e of a){const t=document.createElement("option");t.value=e.value,t.text=e.text,s.add(t)}const r=k("plot-tool");r.append(S("label",!1,t),s),this.div.append(r),s.addEventListener("change",(({target:t})=>{this.userChangesSomething(e,t.options[t.selectedIndex].value)}))}},P=(e,t,a,s,r,o=!1)=>({...m(t,e,`${s}: ${a} `),mode:"lines+markers",hovertemplate:`${a}: %{y}<br>%{x}`,line:b(r,o)}),O={prebuild(){this.toolBar=L.linkToLayout(this),this.toolBar.allowUserToChangeHoverMode()},setSelectableUnits(e){return this.toolBar.allowUserToSelectUnits(e),this},buildLayout(e){this.storeLayoutDataForRebuild(e);const t=[[0,.15],[.2,1]],a=l({type:"x",numTicks:10,useDates:!0,spikes:!0,noMirrorLines:!0}),s=l({type:"y",domain:t[0],useCategories:{showAll:!0,categoryarray:["NPL","PL","HM","CF"]},spikes:!0}),r=l({type:"y",domain:t[1],title:e.yaxis.y2.title,range:e.yaxis.y2.range,spikes:!0}),{name:o,range:i}=this.toolBar.getSelectedUnitNameRange(),d=l(Object.assign({type:"y",title:`VA - ${o}`,domain:t[1],rightSide:"y2",spikes:!0},w(i)));return this.layout=n({legend:!0,xaxis:a,yaxes:[s,r,d],rangeSlider:!0,hovermode:this.toolBar.getHoverMode()}),this},buildData(e){this.storePlotDataForThemeRebuild(e);let t=[];const a={rightEye:"R",leftEye:"L",BEO:"BEO"};for(const s of Object.keys(a))if(e.hasOwnProperty(s)){const r=i(`${s}Series`),o=a[s],l=e[s].VA.units[this.toolBar.getSelectedUnit()];t=t.concat([P(e[s].VA.offScale,"y1","VA",o,r[0]),P(e[s].CRT,"y2","CRT",o,r[1],!0),P(l,"y3","VA",o,r[2])])}return this.data=t,this}},T={...c,...O},D=(e,t,a)=>({...m(t,e,a),hovertemplate:`Mean ± SD<br>${a}: %{y}<br>(N: %{x})`,error_y:g(e)}),R={buildLayout(e){this.storeLayoutDataForRebuild(e);const t=l({type:"x",title:e.xaxis.title,numTicks:20,range:e.xaxis.range}),a=l({type:"y",title:e.yaxis.y1.title,range:e.yaxis.y1.range,numTicks:20}),s=l({type:"y",title:e.yaxis.y2.title,rightSide:"y1",numTicks:20});return this.layout=n({colors:"varied",legend:!0,xaxis:t,yaxes:[a,s],rangeSlider:!0}),this},buildData(e){return this.data=[D(e.VA,"y1","VA"),D(e.IOP,"y2","IOP")],this}},C={...c,...R},E=e=>{let t,s;switch(e){case"management":t="square",s=9;break;case"image":t="triangle-down",s=11;break;case"drug":t="diamond",s=9;break;case"injection":t="star-diamond",s=10;break;default:a("markerFor")}return{symbol:t,size:s}},B=(e,t=!1)=>{const s={marker:E(e)};switch(e){case"management":case"image":case"injection":s.mode="markers";break;case"drug":s.mode="lines+markers",s.line={width:3};break;default:a(`eventStyle - unknown type: ${e}`)}return t&&(s.marker&&(s.marker.color=t),s.line&&(s.line.color=t)),s},A={plots:new Map,toolBar:null,baseLayout:null,buildData(){a("SplitPlots use buildRightData() and/or buildLeftData() instead")},buildDataTraces:()=>(a("Override in specific split layout!"),{}),buildRightData(e){return this.buildSplitData("R",e),this},buildLeftData(e){return this.buildSplitData("L",e),this},buildSplitData(e,t){const s="R"===e?"right":"left",r=document.querySelector(`.oes-${s}-side`);null===r&&a(`Requires fixed DOM structure, can not find: div.'.oes-${s}-side'`);const o=new Map;o.set("storedPlotData",t),o.set("div",r),o.set("data",this.buildDataTraces(t));const i=n({colors:`${s}EyeSeries`,plotTitle:`${e+s.substring(1)} eye`,...this.baseLayout});t.hasOwnProperty("procedures")&&h(i,Object.values(t.procedures),this.procedureVericalHeight),o.set("layout",i),this.plots.set(`${e}`,o)},setBaseLayoutForPlots(e){const t={legend:{yanchor:"bottom"},xaxis:l({type:"x",numTicks:10,useDates:!0,spikes:!0,noMirrorLines:!0}),rangeSlider:!0,dateRangeButtons:!0};this.baseLayout={...t,...e}},buildEvents:(e,t)=>Object.values(e).map((e=>({oeEventType:e.event,...m(t,e,e.name),...B(e.event),customdata:e.customdata,hovertemplate:e.customdata?"%{y}<br>%{customdata}<br>%{x}<extra></extra>":"%{y}<br>%{x}<extra></extra>",showlegend:!1}))),plotlyReact(){["R","L"].forEach((e=>{if(this.plots.has(e)){const t=this.plots.get(e);this.drawLines(t.get("layout")),Plotly.react(t.get("div"),t.get("data"),t.get("layout"),{displayModeBar:!1,responsive:!0})}}))},rebuild(){this.buildLayout(this.stored.get("layout")),["R","L"].forEach((e=>{if(this.plots.has(e)){const t=this.plots.get(e);this.buildSplitData(e,t.get("storedPlotData"))}})),this.plotlyReact()},plotlyThemeChange(){this.rebuild()},listenForViewLayoutChange(){document.addEventListener("oesLayoutChange",(()=>{["R","L"].forEach((e=>{if(this.plots.has(e)){const t=this.plots.get(e);Plotly.relayout(t.get("div"),t.get("layout"))}}))}))}},M={...c,...A},F={prebuild(){this.toolBar=L.linkToLayout(this),this.toolBar.allowUserToChangeHoverMode(),this.listenForViewLayoutChange()},buildLayout(e){this.storeLayoutDataForRebuild(e);const t=[[.7,1],[0,.64]],a=l({type:"y",domain:t[1],title:e.yaxis.y1.title,range:e.yaxis.y1.range,spikes:!0}),s=l({type:"y",domain:t[0],useCategories:{categoryarray:e.allEvents,rangeFit:"pad"},spikes:!0});return this.setBaseLayoutForPlots({legend:{y:t[1][1]},yaxes:[a,s],subplot:t.length,hovermode:this.toolBar.getHoverMode()}),this},buildDataTraces(e){return[{...m("y",e.daily,e.daily.name),mode:"markers",hovertemplate:`${e.daily.name}: %{y}:00<extra></extra>`},...this.buildEvents(e.events,"y2")]}},U={...M,...F},V={prebuild(){this.toolBar=L.linkToLayout(this),this.toolBar.allowUserToChangeHoverMode(),this.listenForViewLayoutChange(),this.procedureVericalHeight=.64},setSelectableUnits(e){return this.toolBar.allowUserToSelectUnits(e),this},buildLayout(e){this.storeLayoutDataForRebuild(e);const t=[[.7,1],[.15,.64],[0,.15]],a=l({type:"y",domain:t[2],useCategories:{categoryarray:["NPL","PL","HM","CF"],rangeFit:"padTop"},spikes:!0}),s=l({type:"y",domain:t[1],title:e.yaxis.y2.title,range:e.yaxis.y2.range,spikes:!0}),r=l({type:"y",domain:t[0],useCategories:{categoryarray:e.allEvents,rangeFit:"pad"},spikes:!0}),{name:o,range:i}=this.toolBar.getSelectedUnitNameRange(),n=l(Object.assign({type:"y",title:`VA - ${o}`,domain:t[1],rightSide:"y2",spikes:!0},w(i)));return this.setBaseLayoutForPlots({legend:{y:t[1][1]},yaxes:[a,s,n,r],subplot:t.length,hovermode:this.toolBar.getHoverMode()}),this},buildDataTraces(e){const t={...m("y1",e.VA.offScale,`${e.VA.offScale.name}`),mode:"lines+markers",hovertemplate:"%{y}<br>%{x}"},a={...m("y2",e.CRT,`${e.CRT.name}`),mode:"lines+markers",hovertemplate:"CRT: %{y}<br>%{x}",line:{dash:"2px,2px",width:2}},s=e.VA.units[this.toolBar.getSelectedUnit()];return[t,a,{...m("y3",s,`${s.name}`),mode:"lines+markers",hovertemplate:s.name+": %{y}<br>%{x}"},...this.buildEvents(e.events,"y4")]}},$={...M,...V},_={prebuild(){this.toolBar=L.linkToLayout(this),this.toolBar.allowUserToChangeHoverMode(),this.listenForViewLayoutChange(),this.procedureVericalHeight=.77},setSelectableUnits(e){return this.toolBar.allowUserToSelectUnits(e),this},buildLayout(e){this.storeLayoutDataForRebuild(e);const t=[[.82,1],[.47,.77],[.1,.42],[0,.1]],a=l({type:"y",domain:t[3],useCategories:{categoryarray:["NPL","PL","HM","CF"],rangeFit:"padTop"},spikes:!0}),s=l({type:"y",domain:t[2],title:e.yaxis.y2.title,range:e.yaxis.y2.range,spikes:!0,maxAxisTicks:12}),r=l({type:"y",domain:t[1],title:e.yaxis.y4.title,range:e.yaxis.y4.range,maxAxisTicks:12,spikes:!0}),o=l({type:"y",domain:t[0],useCategories:{categoryarray:e.allEvents,rangeFit:"pad"},spikes:!0}),{name:i,range:n}=this.toolBar.getSelectedUnitNameRange(),d=l(Object.assign({type:"y",title:`VA - ${i}`,domain:t[1],rightSide:"y2",spikes:!0},w(n)));return this.setBaseLayoutForPlots({legend:{y:t[1][1]},yaxes:[a,s,d,r,o],subplot:t.length,hovermode:this.toolBar.getHoverMode()}),this},buildDataTraces(e){const t={...m("y1",e.VA.offScale,`${e.VA.offScale.name}`),mode:"lines+markers",hovertemplate:"%{y}<br>%{x}"},a={...m("y2",e.VFI,e.VFI.name),mode:"lines+markers",hovertemplate:"%{y}<br>%{x}<extra></extra>",line:{dash:"2px,2px",width:2}},s={...m("y4",e.IOP,e.IOP.name),mode:"lines+markers",hovertemplate:"IOP: %{y}<br>%{x}<extra></extra>"},r=e.VA.units[this.toolBar.getSelectedUnit()];return[t,a,s,{...m("y3",r,`${r.name}`),mode:"lines+markers",hovertemplate:r.name+": %{y}<br>%{x}"},...this.buildEvents(e.events,"y5")]}},H={...M,..._};var j=Object.freeze({__proto__:null,barChart:p,eyesOutcomes_Errors:f,eyesOutcomes_offScale_selectableVA:T,outcomes_Errors:C,splitRL_Adherence:U,splitRL_Glaucoma_selectableVA:H,splitRL_MedicalRetina_selectableVA:$});window.hasOwnProperty("Plotly")?t(`nxPlot is available, using Plot.ly v${Plotly.version}`):a("Plot.ly JS is required");const z=new Set(["barChart","eyesOutcomes_Errors","eyesOutcomes_offScale_selectableVA","outcomes_Errors","splitRL_Adherence","splitRL_Glaucoma_selectableVA","splitRL_MedicalRetina_selectableVA"]),N=new Map;for(const e of z)N.set(e,j[e]);Object.defineProperty(window,"nxPlot",{value:(e,a=!1)=>{let s=!1;try{s=N.get(e),t(`Building: ${e}`)}catch({name:t}){return console.error(`Requested plot template: "${e}" is invalid. \n\t\tValid plotTemplates are:\n${Array.from(N.keys()).join("\n")}`),s}return s.setPlotlyDiv(a),s.prebuild(),document.addEventListener("oeThemeChange",(()=>{s.plotlyThemeChange()})),s},writable:!1})}();
